<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ESP32 LoRa Monitor</title>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>üåø ESP32 LoRa Environment Monitor</h1>
        <p>Real-time environmental monitoring via LoRa</p>
      </header>

      <div class="stats-row">
        <div class="stat-card">
          <span class="stat-label">Active Nodes</span>
          <span class="stat-value" id="active-nodes">0</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Last Update</span>
          <span class="stat-value" id="last-update">--:--:--</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Status</span>
          <span class="stat-value status-dot" id="connection-status">‚óè Connecting...</span>
        </div>
      </div>

      <div class="card">
        <h2>üì° Sensor Data</h2>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Node (ID)</th>
                <th>Timestamp</th>
                <th class="center">üíß Soil Moisture</th>
                <th class="center">üìè Distance</th>
                <th class="center">üîã Battery</th>
                <th class="center">üì∂ RSSI</th>
                <th class="center">üìä SNR</th>
              </tr>
            </thead>
            <tbody id="table-body">
              <tr>
                <td colspan="7" class="center mono">Waiting for sensor data...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>‚ö†Ô∏è Recent Alerts</h2>
        <div id="alerts-container">
          <p class="mono center">No alerts</p>
        </div>
      </div>
    </div>

    <script>
      const DATA_ENDPOINT = "/data";
      const ALERTS_ENDPOINT = "/api/alerts";
      const POLL_INTERVAL = 5000;

      // Classifica√ß√£o de umidade do solo
      function classifyMoisture(value) {
        if (value == null || Number.isNaN(value)) return "";
        if (value < 20) return "moisture-dry";
        if (value < 40) return "moisture-low";
        if (value > 80) return "moisture-wet";
        return "moisture-ok";
      }

      // Classifica√ß√£o de bateria
      function classifyBattery(value) {
        if (value == null || Number.isNaN(value)) return "";
        if (value < 20) return "battery-critical";
        if (value < 40) return "battery-low";
        return "battery-ok";
      }

      // Classifica√ß√£o de sinal RSSI
      function classifyRSSI(value) {
        if (value == null || Number.isNaN(value)) return "";
        if (value < -100) return "signal-weak";
        if (value < -80) return "signal-fair";
        return "signal-good";
      }

      async function fetchAndRender() {
        const statusEl = document.getElementById("connection-status");
        try {
          const res = await fetch(DATA_ENDPOINT);
          if (!res.ok) throw new Error(`status ${res.status}`);
          const payload = await res.json();
          renderTable(payload);
          statusEl.textContent = "‚óè Online";
          statusEl.className = "stat-value status-dot status-online";
        } catch (err) {
          const el = document.getElementById("table-body");
          el.innerHTML = `<tr><td colspan="7" class="center mono">Failed to load data. Is the server running?</td></tr>`;
          statusEl.textContent = "‚óè Offline";
          statusEl.className = "stat-value status-dot status-offline";
          console.error("Fetch error:", err);
        } finally {
          document.getElementById("last-update").textContent =
            new Date().toLocaleTimeString("en-US");
        }
      }

      async function fetchAlerts() {
        try {
          const res = await fetch(ALERTS_ENDPOINT);
          if (!res.ok) return;
          const alerts = await res.json();
          renderAlerts(alerts);
        } catch (err) {
          console.error("Alerts fetch error:", err);
        }
      }

      function renderTable(list) {
        const body = document.getElementById("table-body");
        const activeNodesEl = document.getElementById("active-nodes");

        if (!Array.isArray(list) || list.length === 0) {
          body.innerHTML = `<tr><td colspan="7" class="center mono">No data received yet...</td></tr>`;
          activeNodesEl.textContent = "0";
          return;
        }

        activeNodesEl.textContent = list.length;
        body.innerHTML = "";

        list.forEach((entry) => {
          const node = entry.node_id ?? "N/A";
          const ts = entry.timestamp
            ? new Date(entry.timestamp).toLocaleString("en-US")
            : "N/A";
          const s = entry.sensors || entry;
          const radio = entry.radio || {};

          // Umidade do solo
          const moistureVal = s.humidity_percent ?? s.humidity;
          const moistureDisplay = typeof moistureVal === "number"
            ? moistureVal.toFixed(1) + " %"
            : "N/A";
          const moistureClass = classifyMoisture(moistureVal);

          // Dist√¢ncia (ultrass√¥nico)
          const distVal = s.distance_cm;
          const distDisplay = typeof distVal === "number"
            ? distVal + " cm"
            : "N/A";

          // Bateria
          const battVal = entry.battery_percent ?? s.battery;
          const battDisplay = typeof battVal === "number"
            ? battVal + " %"
            : "N/A";
          const battClass = classifyBattery(battVal);

          // RSSI
          const rssiVal = radio.rssi_dbm ?? s.rssi_dbm;
          const rssiDisplay = typeof rssiVal === "number"
            ? rssiVal + " dBm"
            : "N/A";
          const rssiClass = classifyRSSI(rssiVal);

          // SNR
          const snrVal = radio.snr_db ?? s.snr_db;
          const snrDisplay = typeof snrVal === "number"
            ? snrVal.toFixed(1) + " dB"
            : "N/A";

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="mono node-id">${node}</td>
            <td>${ts}</td>
            <td class="center ${moistureClass}">${moistureDisplay}</td>
            <td class="center">${distDisplay}</td>
            <td class="center ${battClass}">${battDisplay}</td>
            <td class="center ${rssiClass}">${rssiDisplay}</td>
            <td class="center">${snrDisplay}</td>
          `;
          body.appendChild(tr);
        });
      }

      function renderAlerts(alerts) {
        const container = document.getElementById("alerts-container");
        if (!Array.isArray(alerts) || alerts.length === 0) {
          container.innerHTML = `<p class="mono center">No alerts</p>`;
          return;
        }

        container.innerHTML = alerts.slice(0, 5).map(alert => `
          <div class="alert-item ${alert.acknowledged ? 'alert-ack' : ''}">
            <span class="alert-time">${new Date(alert.timestamp).toLocaleString("en-US")}</span>
            <span class="alert-node">Node ${alert.node_id || '?'}</span>
            <span class="alert-msg">${alert.message}</span>
          </div>
        `).join('');
      }

      document.addEventListener("DOMContentLoaded", () => {
        fetchAndRender();
        fetchAlerts();
        setInterval(fetchAndRender, POLL_INTERVAL);
        setInterval(fetchAlerts, POLL_INTERVAL * 2);
      });
    </script>
  </body>
</html>
